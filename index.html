<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Statusa - Tabela povratne informacije</title>
    <style>
        /* Ostavio sam isti CSS kao prethodno za dizajn stranice */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f8f9fa;
        }
        /* ... (ostali CSS ostaje isti kao u prethodnom primeru) ... */
    </style>
</head>
<body>
    <!-- HTML ostaje isti kao prethodno -->
    <h1>Monitor Statusa - Tabela povratne informacije</h1>
    <p class="last-check">Poslednja provera: <span id="lastCheck">nije izvršena</span></p>
    <button class="refresh-btn" onclick="manualRefresh()">Ručno osveži</button>
    
    <div id="notification" class="notification">
        ⚡ Status je promenjen na "Uradjeno"!
    </div>
    
    <table id="statusTable">
        <!-- ... (ostatak tabele ostaje isti) ... -->
    </table>

    <!-- Dodajemo audio element za notifikacioni zvuk -->
    <audio id="notificationSound" preload="auto">
        <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        // Konfiguracija za Airtable API
        const AIRTABLE_API_KEY = 'patDuIFmBKqym8YSo.08ebbc0f176b60726f3f6b792a3e2d828b6ea5fff3260148fd6dbd7e21756268';
        const AIRTABLE_BASE_ID = 'appqbV5XHvwSIDBfm';
        const AIRTABLE_TABLE_NAME = 'Tabela%20povratne%20informacije';
        const CHECK_INTERVAL = 10000; // 10 sekundi
        
        // Globalne promenljive
        let previousDoneIds = new Set();
        let firstLoad = true;
        let notificationPermissionGranted = false;
        
        // Provera dozvola za notifikacije
        function checkNotificationPermission() {
            if (!("Notification" in window)) {
                console.log("Browser ne podržava notifikacije");
                return;
            }
            
            Notification.requestPermission().then(permission => {
                notificationPermissionGranted = permission === "granted";
            });
        }
        
        // Proveri da li je status "Uradjeno"
        function isStatusDone(record) {
            return record.fields['Status'] === 'Uradjeno';
        }
        
        // Dobavi podatke sa Airtable
        async function fetchAirtableData() {
            try {
                const url = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_API_KEY}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.records;
            } catch (error) {
                console.error('Greška pri dobavljanju podataka:', error);
                showErrorNotification('Greška pri učitavanju podataka');
                return [];
            }
        }
        
        // Prikaz podataka u tabeli
        async function updateTable() {
            try {
                const records = await fetchAirtableData();
                const now = new Date();
                document.getElementById('lastCheck').textContent = now.toLocaleTimeString();
                
                const tableBody = document.getElementById('tableBody');
                tableBody.innerHTML = '';
                
                let currentDoneIds = new Set();
                let newDoneItems = [];
                
                records.forEach(record => {
                    const fields = record.fields;
                    const isDone = isStatusDone(record);
                    
                    if (isDone) {
                        currentDoneIds.add(record.id);
                        
                        if (!previousDoneIds.has(record.id)) {
                            newDoneItems.push(record);
                        }
                    }
                    
                    const row = document.createElement('tr');
                    if (isDone) {
                        row.classList.add('status-Uradjeno');
                    }
                    
                    row.innerHTML = `
                        <td>${record.id.substring(0, 8)}...</td>
                        <td>${fields['A. Idialog'] || '-'}</td>
                        <td>${fields['B. Lateral Idialog'] || '-'}</td>
                        <td>${fields['C. General Domain...'] || '-'}</td>
                        <td>${fields['D. Vista Identity'] || '-'}</td>
                        <td>${fields['E. Claims associated length'] || '-'}</td>
                        <td>${fields['F. Claims / names representing votes'] || '-'}</td>
                        <td>${fields['G. Has verbatimize ordinate'] || '-'}</td>
                        <td>${fields['H. Should be written'] || '-'}</td>
                        <td class="status-cell">${fields['Status'] || '-'}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Obrada notifikacija
                if (firstLoad) {
                    if (currentDoneIds.size > 0) {
                        showBrowserNotification(`Pronađeno ${currentDoneIds.size} zapisa sa statusom "Uradjeno"`);
                    }
                    firstLoad = false;
                } else if (newDoneItems.length > 0) {
                    showBrowserNotification(`Novi završeni zadatak: ${newDoneItems[0].id.substring(0, 8)}...`);
                    playNotificationSound();
                }
                
                previousDoneIds = currentDoneIds;
            } catch (error) {
                console.error('Greška pri ažuriranju tabele:', error);
                showErrorNotification('Greška pri ažuriranju tabele');
            }
        }
        
        // Desktop notifikacija
        function showBrowserNotification(message) {
            // Proveri da li su dozvole date
            if (!notificationPermissionGranted) {
                console.log('Dozvole za notifikacije nisu date');
                return;
            }
            
            const options = {
                body: message,
                icon: 'https://cdn-icons-png.flaticon.com/512/3652/3652191.png', // Ikona notifikacije
                vibrate: [200, 100, 200], // Vibracija (ako je podržana)
                tag: 'airtable-notification'
            };
            
            new Notification('Airtable Status', options);
        }
        
        // Reprodukuj zvuk notifikacije
        function playNotificationSound() {
            const sound = document.getElementById('notificationSound');
            sound.currentTime = 0; // Resetujemo na početak ako je već puštan
            sound.play().catch(e => console.log('Greška pri reprodukciji zvuka:', e));
        }
        
        function showErrorNotification(message) {
            if (notificationPermissionGranted) {
                new Notification('Greška', {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/463/463612.png'
                });
            }
        }
        
        function manualRefresh() {
            updateTable();
        }
        
        // Inicijalizacija
        checkNotificationPermission();
        updateTable();
        setInterval(updateTable, CHECK_INTERVAL);
    </script>
</body>
</html>
